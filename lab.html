<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MarFitNova | The Lab</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- CORE STYLES --- */
        :root { --primary: #b829ff; --bg: #000000; } 
        
        body { 
            margin: 0; padding: 0; background-color: #0b0d17; color: #aab2bd; 
            font-family: 'Courier New', monospace; overflow-x: hidden; 
            background-image: linear-gradient(rgba(0, 229, 255, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 229, 255, 0.03) 1px, transparent 1px);
            background-size: 40px 40px; min-height: 100vh; display: flex; flex-direction: column; align-items: center; 
        }

        /* --- NAVIGATION --- */
        nav { position: fixed; top: 0; left: 0; width: 100%; padding: 20px 10%; box-sizing: border-box; display: flex; justify-content: space-between; align-items: center; background: rgba(11, 13, 23, 0.95); border-bottom: 1px solid var(--primary); z-index: 500; transition: border-color 0.5s; }
        .logo { font-size: 1.5rem; font-weight: bold; letter-spacing: 5px; cursor: pointer; color: var(--primary); text-shadow: 0 0 15px var(--primary); text-decoration: none; transition: color 0.5s, text-shadow 0.5s; }
        ul { list-style: none; display: flex; gap: 20px; margin: 0; padding: 0; } 
        li { color: #888; cursor: pointer; transition: 0.3s; font-size: 0.9rem; } 
        li:hover { color: var(--primary); } a { text-decoration: none; color: inherit; } 
        li.active { color: var(--primary); text-shadow: 0 0 10px var(--primary); }

        /* --- HEADER --- */
        .lab-header { width: 90%; margin-top: 100px; display: flex; justify-content: space-between; align-items: flex-end; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 30px; }
        .lab-title h1 { font-size: 2.5rem; color: white; margin: 0; letter-spacing: 5px; }
        .lab-title p { margin: 5px 0 0 0; color: var(--primary); opacity: 0.7; }
        .user-controls { text-align: right; display: flex; flex-direction: column; align-items: flex-end; gap: 10px; }
        .id-code { font-size: 1.5rem; font-weight: bold; color: var(--primary); text-shadow: 0 0 15px var(--primary); transition: color 0.5s; }
        
        .scan-trigger-btn { background: rgba(0,0,0,0.5); border: 1px solid var(--primary); color: var(--primary); padding: 10px 20px; font-size: 0.8rem; cursor: pointer; letter-spacing: 2px; font-weight: bold; text-transform: uppercase; transition: 0.3s; }
        .scan-trigger-btn:hover { background: var(--primary); color: black; box-shadow: 0 0 30px var(--primary); }

        .goto-ranks-btn { display: none; background: #ffd700; color: black; border: none; padding: 10px 20px; font-weight: bold; cursor: pointer; animation: pulseGold 1s infinite; margin-top: 5px; font-family: inherit; letter-spacing: 1px; } 
        @keyframes pulseGold { 0% { box-shadow: 0 0 10px #ffd700; } 50% { box-shadow: 0 0 25px #ffd700; } 100% { box-shadow: 0 0 10px #ffd700; } }

        /* TASK COUNTERS & TIMERS */
        .task-status-row { display: flex; align-items: center; justify-content: flex-end; gap: 10px; margin-bottom: 5px; }
        .task-counter { font-size: 0.7rem; color: #555; border: 1px solid #333; padding: 2px 8px; border-radius: 4px; letter-spacing: 1px; } 
        .task-counter.complete { border-color: #00ff00; color: #00ff00; box-shadow: 0 0 10px rgba(0,255,0,0.2); }
        .cooldown-timer { font-size: 0.7rem; color: #ff4400; font-weight: bold; letter-spacing: 1px; display: none; }
        .cooldown-timer.visible { display: block; animation: blinkRed 2s infinite; }
        @keyframes blinkRed { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* --- TOOL LOCKING --- */
        .tool-disabled { opacity: 0.3; pointer-events: none; filter: grayscale(1); position: relative; }
        .tool-disabled::after { 
            content: 'LOCKED // RECHARGING'; 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #ff4400; font-weight: bold; font-size: 0.7rem; letter-spacing: 2px;
            text-shadow: 0 0 10px black; background: rgba(0,0,0,0.9); padding: 5px; border: 1px solid #ff4400;
            white-space: normal; text-align: center; width: 90%; z-index: 10;
        }

        /* --- GRID LAYOUT --- */
        .schematic-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 30px; width: 90%; margin-bottom: 50px; }
        .blueprint-card { background: rgba(16, 20, 30, 0.8); border: 1px solid #333; position: relative; padding: 0; display: flex; flex-direction: column; } 
        .blueprint-card::before { content: ''; position: absolute; top: -1px; left: -1px; width: 10px; height: 10px; border-top: 2px solid var(--primary); border-left: 2px solid var(--primary); } 
        .blueprint-card::after { content: ''; position: absolute; bottom: -1px; right: -1px; width: 10px; height: 10px; border-bottom: 2px solid var(--primary); border-right: 2px solid var(--primary); }
        .card-header { background: rgba(255, 255, 255, 0.05); padding: 15px; display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 1px solid #333; min-height: 50px; } 
        .card-title { color: white; font-weight: bold; letter-spacing: 2px; margin-top: 5px;} .card-status { color: #00ff00; font-size: 0.8rem; } 
        .card-body { padding: 20px; flex-grow: 1; display: flex; flex-direction: column; gap: 15px; position: relative; }

        .split-body { flex-direction: row; display: flex; gap: 20px; } 
        .diet-section { flex: 3; } .water-section { flex: 1; display: flex; flex-direction: column; align-items: center; border-left: 1px solid #333; padding-left: 20px; justify-content: space-between; position: relative; }
        
        .glass-vial-container { width: 70px; height: 160px; border: 3px solid rgba(255,255,255,0.2); border-radius: 35px; position: relative; overflow: hidden; background: #050a1c; margin-bottom: 10px; } 
        .vial-liquid { position: absolute; bottom: 0; left: 0; width: 100%; height: 0%; background: linear-gradient(180deg, var(--primary), #0044ff); transition: height 0.5s; box-shadow: 0 0 30px var(--primary); } 
        .vial-liquid.success { animation: hydroSurge 1s ease-in-out infinite; } 
        @keyframes hydroSurge { 0% { transform: scaleY(1); filter: brightness(1); } 50% { transform: scaleY(1.05); filter: brightness(1.3); } 100% { transform: scaleY(1); filter: brightness(1); } }
        
        .water-controls-mini { display: flex; flex-direction: column; align-items: center; gap: 5px; width: 100%; } 
        .mini-btn { width: 100%; background: #111; color: var(--primary); border: 1px solid var(--primary); cursor: pointer; padding: 5px; font-weight: bold; font-size: 0.7rem; transition: 0.2s; } 
        .mini-btn:hover { background: var(--primary); color: black; } 
        .water-display { font-size: 0.9rem; color: white; font-weight: bold; }

        .sleep-compact-row { display: flex; align-items: center; justify-content: center; gap: 15px; } 
        .compact-input { width: 70px; background: #000; border: 1px solid #555; color: white; font-family: inherit; font-size: 1.2rem; text-align: center; padding: 10px; } 
        .compact-input:focus { border-color: var(--primary); outline: none; } 
        .log-btn-small { background: var(--primary); color: black; padding: 10px 20px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; } 
        .sleep-label { color: #888; font-size: 0.8rem; }

        .progress-container { margin-bottom: 15px; } .progress-track { width: 100%; height: 6px; background: #222; border-radius: 4px; overflow: hidden; } .progress-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #0044ff, var(--primary)); transition: width 0.5s ease; }
        .food-input-group { display: flex; gap: 5px; margin-bottom: 10px; flex-wrap: wrap; } .food-search { flex: 2; padding: 8px; background: #000; color: white; border: 1px solid #333; } .gram-input { flex: 1; padding: 8px; background: #000; color: white; border: 1px solid #333; text-align: center; } .unit-select { flex: 1; padding: 8px; background: #000; color: var(--primary); border: 1px solid #333; cursor: pointer; font-weight: bold; } .add-food-btn { flex: 1; padding: 8px; background: #333; color: #00ff00; border: 1px solid #00ff00; cursor: pointer; font-weight: bold; transition: 0.3s; font-size: 0.8rem; } .add-food-btn:hover { background: #00ff00; color: black; }
        .food-log { height: 120px; overflow-y: auto; border-top: 1px dashed #333; padding-top: 10px; scrollbar-width: thin; scrollbar-color: var(--primary) #111; } .log-item { display: flex; justify-content: space-between; align-items: center; padding: 5px 8px; border-bottom: 1px solid #222; background: rgba(0,0,0,0.3); margin-bottom: 3px; } .log-info { display: flex; flex-direction: column; } .log-name { color: white; font-weight: bold; font-size: 0.8rem; } .log-macros { color: #888; font-size: 0.6rem; letter-spacing: 1px; }

        /* WORKOUT LIST UI */
        .split-selector { width: 100%; padding: 10px; background: #000; color: white; border: 1px solid #333; margin-bottom: 15px; font-family: inherit; cursor: pointer; } .split-preview { border: 1px solid #333; background: #0b0d17; padding: 15px; height: 250px; overflow-y: auto; margin-bottom: 15px; scrollbar-width: thin; scrollbar-color: var(--primary) #111; } 
        .preview-row { display: flex; justify-content: space-between; font-size: 0.8rem; border-bottom: 1px solid #222; padding: 12px 10px; cursor: pointer; transition: 0.2s; position: relative; } 
        .preview-row:hover { background: rgba(255, 255, 255, 0.1); border-left: 3px solid var(--primary); } 
        .active-day-row { background: rgba(0, 229, 255, 0.1); border-left: 3px solid #00e5ff; padding-left: 5px; } 
        .completed-day-row { border-left: 3px solid #00ff00 !important; background: rgba(0, 255, 0, 0.05); opacity: 0.6; } 
        
        /* LOCKED STATE CENTERED OVERLAY */
        .locked-day-row { opacity: 0.5; cursor: not-allowed; border-left: 3px solid #ff0000; position: relative; }
        .locked-day-row:hover { background: none; border-left-color: #ff0000; }
        
        .lock-overlay { 
            position: absolute; 
            left: 50%; top: 50%; 
            transform: translate(-50%, -50%); 
            font-size: 0.7rem; 
            color: #ff4400; 
            font-weight: bold; 
            display: flex; gap: 5px; align-items: center; 
            background: rgba(0, 0, 0, 0.9); 
            padding: 5px 15px;
            border: 1px solid #ff4400;
            z-index: 10;
        }

        .confirm-btn { width: 100%; padding: 12px; background: var(--primary); color: black; font-weight: bold; border: none; cursor: pointer; transition: 0.3s; } .reset-protocol-btn { width: 100%; padding: 10px; background: transparent; color: #ff4400; border: 1px solid #ff4400; cursor: pointer; font-size: 0.8rem; margin-top: 10px; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10000; display: none; justify-content: center; align-items: center; } .modal-overlay.open { display: flex; } .reward-box { width: 400px; background: #050a1c; border: 2px solid #00ff00; padding: 30px; text-align: center; box-shadow: 0 0 80px rgba(0,255,0,0.2); animation: popReward 0.4s ease-out; position: relative; } .reward-icon { font-size: 4rem; color: #00ff00; margin-bottom: 20px; text-shadow: 0 0 30px #00ff00; animation: spinReward 3s infinite linear; } .reward-title { font-size: 1.5rem; color: white; letter-spacing: 3px; font-weight: bold; margin-bottom: 10px; } .reward-sub { color: #888; font-size: 0.9rem; margin-bottom: 20px; } .reward-xp { font-size: 2rem; color: #ffd700; font-weight: bold; margin-bottom: 25px; display: block; text-shadow: 0 0 10px #ffd700; } .reward-actions { display: flex; gap: 10px; } .btn-claim { flex: 1; background: #00ff00; color: black; border: none; padding: 15px; font-weight: bold; cursor: pointer; transition: 0.2s; } .btn-claim:hover { background: white; box-shadow: 0 0 20px white; } .btn-later { flex: 1; background: transparent; color: #555; border: 1px solid #333; padding: 15px; font-weight: bold; cursor: pointer; } .btn-later:hover { color: white; border-color: white; } @keyframes popReward { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } } @keyframes spinReward { 0% { transform: rotateY(0deg); } 100% { transform: rotateY(360deg); } }
        .intel-box { width: 800px; background: #0b0d17; border: 1px solid var(--primary); padding: 0; position: relative; box-shadow: 0 0 80px rgba(255,255,255,0.1); max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; } .intel-header { background: linear-gradient(90deg, rgba(255, 255, 255, 0.1), transparent); padding: 20px 30px; border-bottom: 1px solid var(--primary); display: flex; justify-content: space-between; align-items: center; } .intel-title { color: white; font-size: 1.8rem; letter-spacing: 4px; font-weight: bold; text-transform: uppercase; margin: 0; } .close-intel { font-size: 2rem; color: #555; cursor: pointer; transition: 0.2s; } .close-intel:hover { color: white; } .workout-table { width: 100%; border-collapse: separate; border-spacing: 0 5px; padding: 20px; } .workout-table th { text-align: left; padding: 10px 20px; color: var(--primary); font-size: 0.7rem; letter-spacing: 2px; opacity: 0.7; border-bottom: 1px solid #333; } .workout-table td { padding: 20px; background: rgba(255, 255, 255, 0.02); border: 1px solid transparent; transition: 0.2s; color: #ccc; font-size: 0.9rem; } .workout-table tr:hover td { background: rgba(255, 255, 255, 0.05); border-color: rgba(255, 255, 255, 0.2); color: white; } .ex-name { font-weight: bold; font-size: 1rem; color: white; letter-spacing: 1px; } .cell-check { text-align: center; width: 50px; } .mission-checkbox { appearance: none; width: 20px; height: 20px; border: 1px solid #555; background: black; cursor: pointer; display: inline-block; position: relative; } .mission-checkbox:checked { background: #00ff00; border-color: #00ff00; box-shadow: 0 0 10px #00ff00; } .modal-footer { padding: 20px 30px; border-top: 1px solid #333; text-align: right; background: rgba(0,0,0,0.5); } .complete-workout-btn { padding: 15px 40px; background: #333; color: #888; font-weight: bold; border: 1px solid #555; cursor: not-allowed; transition: 0.3s; letter-spacing: 2px; text-transform: uppercase; } .complete-workout-btn.active { background: #00ff00; color: black; border-color: #00ff00; cursor: pointer; box-shadow: 0 0 30px rgba(0,255,0,0.4); }
        .calibration-box { width: 600px; background: #050a1c; border: 2px solid var(--primary); padding: 40px; text-align: left; position: relative; box-shadow: 0 0 50px rgba(255, 255, 255, 0.2); } .onboarding-box { text-align: center; border-color: var(--primary); box-shadow: 0 0 50px rgba(255, 255, 255, 0.2); } .cal-title { color: var(--primary); font-size: 1.5rem; letter-spacing: 3px; border-bottom: 1px solid #333; padding-bottom: 15px; margin-bottom: 20px; } .question-group { margin-bottom: 25px; } .cal-question { color: #aaa; font-size: 0.8rem; margin-bottom: 8px; display: block; font-weight: bold; letter-spacing: 2px; } .cal-options { display: flex; gap: 10px; flex-wrap: wrap; } .option-btn { flex: 1; padding: 12px; background: rgba(0,0,0,0.5); border: 1px solid #333; color: #888; cursor: pointer; text-align: center; font-size: 0.8rem; transition: 0.2s; letter-spacing: 1px; min-width: 80px; } .option-btn.selected { background: var(--primary); color: black; border-color: var(--primary); font-weight: bold; } .scan-select { width: 100%; padding: 15px; background: #000; border: 1px solid var(--primary); color: var(--primary); font-family: inherit; letter-spacing: 2px; font-weight: bold; cursor: pointer; text-align: center; } .metric-row { display: flex; gap: 20px; } .metric-input { width: 100%; padding: 12px; background: rgba(0,0,0,0.5); border: 1px solid #333; color: white; font-family: inherit; font-size: 0.9rem; text-align: center; } .scan-btn { width: 100%; padding: 15px; background: transparent; border: 1px solid #00ff00; color: #00ff00; font-weight: bold; cursor: pointer; letter-spacing: 2px; margin-top: 10px; transition: 0.3s; } .strategy-row { display:flex; justify-content: space-between; align-items:center; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px; } .strategy-select { background: #000; color: var(--primary); border: 1px solid var(--primary); font-family: inherit; font-size: 0.7rem; padding: 5px; cursor: pointer; font-weight: bold; } .macro-dashboard { display: flex; justify-content: space-between; margin-bottom: 15px; text-align: center; gap: 5px; } .macro-stat { flex: 1; background: #111; padding: 8px; border: 1px solid #333; } .macro-num { display: block; font-size: 1rem; color: white; font-weight: bold; } .loader-bar { width: 100%; height: 6px; background: #111; margin: 30px 0; position: relative; overflow: hidden; border-radius: 3px; } .loader-fill { width: 0%; height: 100%; background: linear-gradient(90deg, var(--primary), #fff, var(--primary)); transition: width 2.5s ease-in-out; }
    </style>
    
    <script>
        (function() {
            function getUserPrefix() { return localStorage.getItem('mfn_user') ? (localStorage.getItem('mfn_user') + '_') : 'GUEST_'; }
            let prefix = getUserPrefix();
            let lvl = parseInt(localStorage.getItem(prefix + 'mfn_level') || '1');
            let color = '#b829ff'; 
            if(lvl >= 21) color = '#ffd700'; 
            else if(lvl >= 16) { color = '#6a00ff'; document.documentElement.classList.add('rank-singularity'); }
            else if(lvl >= 11) color = '#00e5ff'; 
            else if(lvl >= 6) color = '#ff4400'; 
            document.documentElement.style.setProperty('--primary', color);
        })();
    </script>
</head>
<body>

    <nav>
        <a href="index.html" class="logo">MFN</a>
        <ul>
            <li onclick="window.location.href='ascension.html'">RANKS</li>
            <li class="active">LAB</li>
            <li><a href="plans.html">PLANS</a></li>
        </ul>
    </nav>

    <div id="questRewardModal" class="modal-overlay" style="z-index: 20000;">
        <div class="reward-box">
            <i class="fa-solid fa-box-open reward-icon"></i>
            <div class="reward-title">QUEST COMPLETE</div>
            <div class="reward-sub" id="rewardMsg">OBJECTIVE FULFILLED</div>
            <span class="reward-xp" id="rewardXpValue">+50 XP</span>
            <div class="reward-actions">
                <button class="btn-claim" onclick="claimAndRedirect()">CLAIM & GO TO RANKS</button>
                <button class="btn-later" onclick="stashReward()">STASH FOR LATER</button>
            </div>
        </div>
    </div>

    <div id="onboardingModal" class="modal-overlay">
        <div class="calibration-box onboarding-box">
            <h1 class="onboarding-title">INITIALIZING LINK</h1>
            <p class="onboarding-msg">Welcome, Operative. To generate your physical trajectory and optimization protocols, the system requires biometric calibration.</p>
            <p style="color: #ff4400; font-weight: bold; font-size: 0.8rem; margin-top: 15px; border: 1px solid #ff4400; padding: 10px; display: inline-block;">⚠ WARNING: ONE-TIME CALIBRATION<br>PERMANENT FOR THIS ACCOUNT</p>
            <br>
            <button class="scan-btn" style="border-color:#b829ff; color:#b829ff;" onclick="startOnboarding()">CUSTOMIZE EXPERIENCE</button>
        </div>
    </div>

    <div id="calibrationModal" class="modal-overlay">
        <div class="calibration-box">
            <span class="close-intel" onclick="toggleModal()" style="top:10px; right:15px; font-size:1.5rem;">&times;</span>
            <div id="questionsUI">
                <div class="cal-title">BIO-SCAN INITIALIZED</div>
                <div class="question-group"><label class="cal-question">1. BIOLOGICAL FRAME</label><div class="cal-options" id="qGender"><div class="option-btn" onclick="selectOpt('qGender', this)">MALE</div><div class="option-btn" onclick="selectOpt('qGender', this)">FEMALE</div></div></div>
                <div class="question-group"><label class="cal-question">2. FRAME METRICS</label><div class="metric-row"><input type="number" class="metric-input" placeholder="HEIGHT (CM)"><input type="number" class="metric-input" placeholder="WEIGHT (KG)"></div></div>
                <div class="question-group"><label class="cal-question">3. AGE BRACKET</label><div class="metric-row"><input type="number" class="metric-input" placeholder="AGE (YEARS)" id="ageInput"></div></div>
                <div class="question-group"><label class="cal-question">4. SELECT PROTOCOL</label><select id="scanSplitSelect" class="scan-select"><option value="">-- SELECT SPLIT --</option></select></div>
                <div class="question-group"><label class="cal-question">5. PRIMARY OBJECTIVE</label><div class="cal-options" id="qGoal"><div class="option-btn" onclick="selectOpt('qGoal', this)">MASS</div><div class="option-btn" onclick="selectOpt('qGoal', this)">POWER</div></div></div>
                <div class="question-group"><label class="cal-question">6. CURRENT PHASE</label><div class="cal-options" id="qPhase"><div class="option-btn" onclick="selectOpt('qPhase', this)">BULK</div><div class="option-btn" onclick="selectOpt('qPhase', this)">CUT</div><div class="option-btn" onclick="selectOpt('qPhase', this)">MAINTAIN</div></div></div>
                <button class="scan-btn" onclick="startScan()">RUN DIAGNOSTICS</button>
            </div>
            <div id="scanningUI" style="display:none; text-align:center; padding:40px 0;">
                <div class="cal-title" style="color:white; border:none;">ANALYZING BIOMETRICS...</div>
                <div class="loader-bar"><div id="scanLoaderFill" class="loader-fill"></div></div>
                <div id="scanText" style="color:var(--primary); letter-spacing:3px;">CALCULATING MUSCLE DENSITY...</div>
            </div>
        </div>
    </div>

    <div id="intelModal" class="modal-overlay">
        <div class="intel-box">
            <div class="intel-header">
                <h2 class="intel-title" id="intelTitle">WORKOUT DATA</h2>
                <span class="close-intel" onclick="closeIntel()">&times;</span>
            </div>
            <table class="workout-table">
                <thead>
                    <tr><th class="cell-check">STATUS</th><th>EXERCISE</th><th>SETS</th><th>REPS</th><th>REST</th></tr>
                </thead>
                <tbody id="intelTableBody"></tbody>
            </table>
            <div class="modal-footer">
                <button id="completeBtn" class="complete-workout-btn" onclick="completeWorkoutMission()" disabled>COMPLETE MISSION <i class="fa-solid fa-lock"></i></button>
            </div>
        </div>
    </div>

    <div class="lab-header">
        <div class="lab-title"><h1>R.S.L. TERMINAL</h1><p>ROCKET SCIENCE LAB // BIOMETRIC ANALYSIS</p></div>
        <div class="user-controls">
            <div style="font-size: 0.8rem; color: #888;">SUBJECT ID</div>
            <div class="id-code" id="userDisplay">UNKNOWN</div>
            <button class="scan-trigger-btn" id="bioScanBtn" onclick="openCalibration()">RUN BIO-SCAN</button>
            <button id="goToRanksBtn" class="goto-ranks-btn" onclick="window.location.href='ascension.html'">
                <i class="fa-solid fa-trophy"></i> OPEN RANKS TO CLAIM (<span id="stashCount">0</span>)
            </button>
        </div>
    </div>

    <div class="schematic-grid">
        <div class="blueprint-card">
            <div class="card-header">
                <span class="card-title">NEURAL LINK // PROTOCOL</span>
                <span class="card-status" id="protocolStatus">● STANDBY</span>
                <div class="task-wrapper">
                    <span class="task-counter" id="taskProtocol">[ 0/1 ]</span>
                </div>
            </div>
            <div class="card-body">
                <div id="selectorContainer">
                    <div style="text-align:center; padding: 40px; color: #555;">
                        <i class="fa-solid fa-lock" style="font-size: 2rem; margin-bottom: 20px;"></i><br>
                        NO PROTOCOL DETECTED.<br>RUN BIO-SCAN TO ASSIGN MISSION.
                    </div>
                    <button class="confirm-btn" onclick="openCalibration()">INITIALIZE LINK</button>
                </div>
                <div id="activeContainer" style="display:none;">
                    <div style="font-size:0.9rem; color:#00ff00; margin-bottom:10px; border-bottom:1px solid #333; padding-bottom:5px;">MISSION TIMELINE // CLICK DAY FOR INTEL</div>
                    <div class="split-preview" id="scheduleList" style="height:300px;"></div>
                    <button class="reset-protocol-btn" onclick="resetProtocol()">ABORT PROTOCOL (RESET)</button>
                </div>
            </div>
        </div>

        <div class="blueprint-card">
            <div class="card-header">
                <span class="card-title">METABOLIC ENGINE // DIET & HYDRO</span>
                <div style="text-align:right;">
                    <div class="task-status-row">
                        <span class="task-counter" id="taskDiet">[ 0/1 ]</span>
                        <div id="timerDiet" class="cooldown-timer"></div>
                    </div>
                    <div class="task-status-row">
                        <span class="task-counter" id="taskWater">[ 0/1 ]</span>
                        <div id="timerWater" class="cooldown-timer"></div>
                    </div>
                </div>
            </div>
            <div class="card-body split-body">
                <div class="diet-section">
                    <div class="strategy-row">
                        <label style="color:#aaa; font-size:0.8rem;">PROTEIN PROTOCOL:</label>
                        <select id="protStrategy" class="strategy-select" onchange="changeStrategy()">
                            <option value="HIGH">HIGH END (2.2g/kg)</option>
                            <option value="LOW">LOW END (1.6g/kg)</option>
                        </select>
                    </div>
                    <div class="progress-container"><div class="progress-label"><span>DAILY ENERGY</span> <span><span id="calsConsumed">0</span> / <span id="calsTarget">2500</span> KCAL</span></div><div class="progress-track"><div class="progress-bar" id="calBar"></div></div></div>
                    <div class="macro-dashboard">
                        <div class="macro-stat"><span class="macro-num"><span id="protCurrent">0</span>g <span class="macro-target">/ <span id="protTarget">0</span>g</span></span><span class="macro-name">PROTEIN</span></div>
                        <div class="macro-stat"><span class="macro-num"><span id="carbCurrent">0</span>g <span class="macro-target">/ <span id="carbTarget">0</span>g</span></span><span class="macro-name">CARBS</span></div>
                        <div class="macro-stat"><span class="macro-num"><span id="fatCurrent">0</span>g <span class="macro-target">/ <span id="fatTarget">0</span>g</span></span><span class="macro-name">FATS</span></div>
                    </div>
                    <div class="food-input-group"><input type="text" id="foodSearch" class="food-search" placeholder="Food Name"><input type="number" id="foodQty" class="gram-input" placeholder="Amount"><select id="foodUnit" class="unit-select"><option value="g">GRAMS (g)</option><option value="x">QTY (x)</option><option value="tbsp">TBSP</option></select><button id="addFoodBtn" class="add-food-btn" onclick="fetchFoodData()">INJECT</button></div>
                    <div class="food-log" id="foodLog"></div>
                </div>
                <div class="water-section" id="waterSection">
                    <div class="glass-vial-container">
                        <div class="vial-glare"></div>
                        <div class="vial-liquid" id="waterFill"><div class="wave"></div><div class="wave2"></div><div class="bubble b1"></div><div class="bubble b2"></div><div class="bubble b3"></div></div>
                    </div>
                    <div class="water-controls-mini">
                        <div class="water-display"><span id="waterCurrent">0.0</span>L</div>
                        <button class="mini-btn" onclick="updateWater(0.25)">+ 250ML</button>
                        <button class="mini-btn" style="border-color:#555; color:#555;" onclick="updateWater(-0.25)">-</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="blueprint-card" style="grid-column: span 2;">
            <div class="card-header">
                <span class="card-title">HYPERSLEEP CHAMBER</span>
                <i class="fa-solid fa-bed" style="color:#888;"></i>
                <div class="task-wrapper">
                    <span class="task-counter" id="taskSleep">[ 0/1 ]</span>
                    <span id="timerSleep" class="cooldown-timer"></span>
                </div>
            </div>
            <div class="card-body" id="sleepBody">
                <div class="sleep-compact-row">
                    <label class="sleep-label">INPUT DATA:</label>
                    <input type="number" id="quickSleepInput" class="compact-input" placeholder="0.0" step="0.5">
                    <label class="sleep-label">HOURS</label>
                    <button class="log-btn-small" onclick="quickLogSleep()">LOG SLEEP</button>
                </div>
                <div style="text-align:center; margin-top:10px; color:#555; font-size:0.8rem; letter-spacing:1px;" id="lastSleepLog">LAST RECORD: NO DATA</div>
            </div>
        </div>
    </div>

    <script>
        // API CREDENTIALS
        const APP_ID = "b1bec0a2"; 
        const APP_KEY = "9a9e7a65ba7c5e27294930e2d1b2d5b1"; 

        function getUserPrefix() { return localStorage.getItem('mfn_user') ? (localStorage.getItem('mfn_user') + '_') : 'GUEST_'; }
        function save(key, val) { localStorage.setItem(getUserPrefix() + key, val); }
        function load(key) { return localStorage.getItem(getUserPrefix() + key); }

        let userData = {}; let waterIntake = 0; let waterGoal = 3.7; 
        
        let taskTimers = {};
        let pendingClaims = [];
        let currentReward = null;

        const allSplits = [ 
            { name: "FULL BODY A/B (3 Days)", days: ["FB_A", "REST", "FB_B", "REST", "FB_A", "REST", "REST"] }, 
            { name: "UPPER / LOWER (4 Days)", days: ["UPPER_POWER", "LOWER_POWER", "REST", "UPPER_HYPERTROPHY", "LOWER_HYPERTROPHY", "REST", "REST"] }, 
            { name: "UPPER/LOWER/PPL (5 Days)", days: ["UPPER_POWER", "LOWER_POWER", "REST", "PUSH", "PULL", "LEGS", "REST"] }, 
            { name: "PUSH / PULL / LEGS (6 Days)", days: ["PUSH", "PULL", "LEGS", "PUSH", "PULL", "LEGS", "REST"] } 
        ];

        window.onload = function() {
            checkDailyReset();
            let savedUser = localStorage.getItem('mfn_user') || "GUEST";
            document.getElementById("userDisplay").innerText = savedUser.toUpperCase();
            
            if(load('mfn_pending_claims')) { 
                pendingClaims = JSON.parse(load('mfn_pending_claims'));
                updateStashUI();
            }

            taskTimers = JSON.parse(load('mfn_task_timers') || '{}');
            setInterval(updateTickers, 1000); 

            let scanSelect = document.getElementById("scanSplitSelect");
            allSplits.forEach((split, index) => { let opt = document.createElement("option"); opt.value = index; opt.innerText = split.name; scanSelect.appendChild(opt); });

            // STRICT BIO CHECK
            let savedData = load('mfn_bio_data'); 
            if(savedData) {
                document.getElementById('bioScanBtn').style.display = 'none';
                userData = JSON.parse(savedData); 
                if(userData.proteinStrategy) document.getElementById("protStrategy").value = userData.proteinStrategy;
                else userData.proteinStrategy = "HIGH";
                calculateDiet(userData); 
            } else if (savedUser !== 'GUEST') {
                document.getElementById("onboardingModal").classList.add("open"); 
            }
            
            if (load('mfn_water_today')) { waterIntake = parseFloat(load('mfn_water_today')); updateWaterUI(); }
            if (load('mfn_food_log')) { dailyLog = JSON.parse(load('mfn_food_log')); updateDietUI(); renderFoodList(); }
            if (load('mfn_active_protocol')) renderActiveProtocol();
        };

        function checkDailyReset() {
            let today = new Date().toDateString();
            let lastReset = load('mfn_last_reset');
            if (lastReset !== today) {
                save('mfn_last_reset', today);
                localStorage.removeItem(getUserPrefix() + 'mfn_water_today'); 
                localStorage.removeItem(getUserPrefix() + 'mfn_food_log');
            }
        }

        // --- TIMER ENGINE & TOOL LOCKING ---
        function updateTickers() {
            checkTimer('diet');
            checkTimer('water');
            checkTimer('sleep');
            checkTimer('protocol');
            if(isTimerActive('protocol')) renderActiveProtocol(); 
        }

        function isTimerActive(key) {
            if(!taskTimers[key]) return false;
            let now = Date.now();
            let unlockTime = taskTimers[key] + (24 * 60 * 60 * 1000);
            return now < unlockTime;
        }

        function checkTimer(key) {
            let timerEl = document.getElementById("timer" + key.charAt(0).toUpperCase() + key.slice(1));
            let badgeEl = document.getElementById("task" + key.charAt(0).toUpperCase() + key.slice(1));
            
            if (!taskTimers[key]) {
                if(timerEl) { timerEl.style.display = "none"; timerEl.classList.remove("visible"); }
                if(badgeEl) { badgeEl.classList.remove("complete"); badgeEl.innerText = "[ 0/1 ]"; }
                
                // UNLOCK TOOLS
                if(key === 'water') document.getElementById('waterSection').classList.remove('tool-disabled');
                if(key === 'sleep') document.getElementById('sleepBody').classList.remove('tool-disabled');
                return;
            }

            let now = Date.now();
            let unlockTime = taskTimers[key] + (24 * 60 * 60 * 1000); 
            let diff = unlockTime - now;

            if (diff > 0) {
                let h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                let m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                let s = Math.floor((diff % (1000 * 60)) / 1000);
                if(timerEl) {
                    timerEl.innerText = `RESETS IN ${h}h ${m}m ${s}s`;
                    timerEl.classList.add("visible");
                    timerEl.style.display = "inline-block";
                }
                if(badgeEl) { badgeEl.classList.add("complete"); badgeEl.innerText = "[ DONE ]"; }
                
                // LOCK TOOLS (EXCEPT DIET)
                if(key === 'water') document.getElementById('waterSection').classList.add('tool-disabled');
                if(key === 'sleep') document.getElementById('sleepBody').classList.add('tool-disabled');

            } else {
                delete taskTimers[key];
                save('mfn_task_timers', JSON.stringify(taskTimers));
                if(key === 'water') { waterIntake = 0; save('mfn_water_today', 0); updateWaterUI(); }
                if(key === 'diet') { dailyLog = { p: 0, c: 0, f: 0, k: 0, list: [] }; save('mfn_food_log', JSON.stringify(dailyLog)); updateDietUI(); renderFoodList(); }
                
                if(timerEl) { timerEl.classList.remove("visible"); timerEl.innerText = ""; }
                if(badgeEl) { badgeEl.classList.remove("complete"); badgeEl.innerText = "[ 0/1 ]"; }
                
                // UNLOCK
                if(key === 'water') document.getElementById('waterSection').classList.remove('tool-disabled');
                if(key === 'sleep') document.getElementById('sleepBody').classList.remove('tool-disabled');
            }
        }

        function setTaskComplete(key) {
            if (isTimerActive(key)) return;
            taskTimers[key] = Date.now();
            save('mfn_task_timers', JSON.stringify(taskTimers));
            triggerQuestComplete(key, 50);
            checkTimer(key);
        }

        function triggerQuestComplete(taskKey, xpAmount) {
            currentReward = { key: taskKey, xp: xpAmount, desc: taskKey.toUpperCase() + " COMPLETE" };
            document.getElementById("rewardMsg").innerText = taskKey.toUpperCase() + " OBJECTIVE FULFILLED";
            document.getElementById("rewardXpValue").innerText = "+" + xpAmount + " XP";
            document.getElementById("questRewardModal").classList.add("open");
        }
        
        function claimAndRedirect() { 
            // 1. ADD XP
            let currentXP = parseInt(load('mfn_xp') || '0');
            save('mfn_xp', currentXP + currentReward.xp);
            
            // 2. MARK AS DONE IN RANKS (SYNC FIX)
            let completed = JSON.parse(load('mfn_completed_quests') || '[]');
            if(!completed.includes(currentReward.key)) {
                completed.push(currentReward.key);
                save('mfn_completed_quests', JSON.stringify(completed));
            }
            
            // 3. REDIRECT
            window.location.href = 'ascension.html'; 
        }
        
        function stashReward() { 
            pendingClaims.push(currentReward); 
            save('mfn_pending_claims', JSON.stringify(pendingClaims)); 
            updateStashUI(); 
            document.getElementById("questRewardModal").classList.remove("open"); 
            currentReward = null; 
        }
        
        function updateStashUI() { let btn = document.getElementById("goToRanksBtn"); let countSpan = document.getElementById("stashCount"); countSpan.innerText = pendingClaims.length; if(pendingClaims.length > 0) btn.style.display = "inline-block"; else btn.style.display = "none"; }

        function openWorkoutDetails(workoutKey) {
            if(event.currentTarget.classList.contains('locked-day-row')) return;
            let workout = workoutLibrary[workoutKey] || workoutLibrary["REST"]; 
            let tableBody = document.getElementById("intelTableBody"); 
            document.getElementById("intelTitle").innerText = workoutKey.replace(/_/g, " "); 
            tableBody.innerHTML = "";
            let completeBtn = document.getElementById("completeBtn"); 

            if(isTimerActive('protocol')) {
                 completeBtn.disabled = true; completeBtn.classList.remove("active"); 
                 completeBtn.innerHTML = 'COOLDOWN ACTIVE <i class="fa-solid fa-clock"></i>';
            } else {
                 completeBtn.disabled = true; completeBtn.classList.remove("active"); 
                 completeBtn.innerHTML = 'COMPLETE MISSION <i class="fa-solid fa-lock"></i>';
            }

            workout.forEach((ex) => { 
                let scheme = getScheme(ex.type || "isolation"); 
                if(workoutKey === "REST") scheme = { s: "-", r: "-", rest: "-" }; 
                let row = document.createElement("tr"); 
                row.innerHTML = `<td class="cell-check"><input type="checkbox" class="mission-checkbox" onchange="checkAllCompleted()"></td><td class="ex-name">${ex.name}</td><td>${scheme.s}</td><td>${scheme.r}</td><td>${scheme.rest}</td>`; 
                tableBody.appendChild(row); 
            });
            document.getElementById("intelModal").classList.add("open");
        }

        function checkAllCompleted() { 
            if (isTimerActive('protocol')) return;
            let checkboxes = document.querySelectorAll(".mission-checkbox"); 
            let allChecked = true; 
            checkboxes.forEach(box => { if(!box.checked) allChecked = false; }); 
            let btn = document.getElementById("completeBtn"); 
            if(allChecked) { btn.disabled = false; btn.classList.add("active"); btn.innerHTML = 'COMPLETE MISSION <i class="fa-solid fa-check"></i>'; } 
            else { btn.disabled = true; btn.classList.remove("active"); btn.innerHTML = 'COMPLETE MISSION <i class="fa-solid fa-lock"></i>'; } 
        }

        function closeIntel() { document.getElementById("intelModal").classList.remove("open"); }
        
        function completeWorkoutMission() { 
            if(isTimerActive('protocol')) return;
            let progress = parseInt(load('mfn_workout_progress') || '0');
            save('mfn_workout_progress', progress + 1); 
            setTaskComplete('protocol'); 
            renderActiveProtocol();
            closeIntel(); 
        }

        function renderActiveProtocol() { 
            document.getElementById("selectorContainer").style.display = "none"; 
            document.getElementById("activeContainer").style.display = "block"; 
            document.getElementById("protocolStatus").innerText = "● LOCKED & ACTIVE"; document.getElementById("protocolStatus").style.color = "#00ff00"; 
            let data = JSON.parse(load('mfn_active_protocol')); 
            let startDate = new Date(data.startDate); 
            let progress = parseInt(load('mfn_workout_progress') || '0'); 
            let container = document.getElementById("scheduleList"); container.innerHTML = ""; 
            
            for (let i = 0; i < 30; i++) { 
                let currentDay = new Date(startDate); currentDay.setDate(startDate.getDate() + i); 
                let cycleIndex = i % data.cycle.length; 
                let workoutKey = data.cycle[cycleIndex]; 
                let row = document.createElement("div"); row.className = "preview-row"; 
                
                if (i < progress) {
                    row.classList.add("completed-day-row"); 
                    row.innerHTML = `<span class="preview-day" style="color:#ffd700;">DAY ${i+1} (DONE)</span> <span style="color:#888; text-decoration:line-through;">${workoutKey.replace(/_/g, " ")}</span> <i class="fa-solid fa-check" style="color:#ffd700;"></i>`; 
                } 
                else if (i === progress) {
                    if (isTimerActive('protocol')) {
                        row.classList.add("locked-day-row");
                        let timeLeft = document.getElementById("timerProtocol") ? document.getElementById("timerProtocol").innerText.replace("RESETS IN ", "") : "WAIT";
                        row.innerHTML = `<span class="preview-day">DAY ${i+1}</span> <span>${workoutKey.replace(/_/g, " ")}</span> <div class="lock-overlay"><i class="fa-solid fa-lock"></i> ${timeLeft}</div>`;
                    } else {
                        row.classList.add("active-day-row"); 
                        row.onclick = function() { openWorkoutDetails(workoutKey); };
                        row.innerHTML = `<span class="preview-day">DAY ${i+1} (READY)</span> <span style="color:#fff; font-weight:bold;">${workoutKey.replace(/_/g, " ")} <i class="fa-solid fa-play" style="font-size:0.7rem; color:#00ff00;"></i></span>`; 
                    }
                } 
                else {
                    row.style.opacity = "0.3"; row.style.pointerEvents = "none";
                    row.innerHTML = `<span><span class="preview-day">DAY ${i+1}</span></span> <span>${workoutKey.replace(/_/g, " ")}</span> <i class="fa-solid fa-lock" style="font-size:0.7rem;"></i>`; 
                }
                container.appendChild(row); 
            } 
        }

        // --- DIET/WATER/SLEEP/BIO ---
        function startOnboarding() { document.getElementById("onboardingModal").classList.remove("open"); setTimeout(() => { openCalibration(); }, 500); }
        function openCalibration() { document.getElementById("calibrationModal").classList.add("open"); }
        function toggleModal() { document.getElementById("calibrationModal").classList.remove("open"); setTimeout(() => { document.getElementById("questionsUI").style.display="block"; document.getElementById("scanningUI").style.display="none"; }, 500); }
        function selectOpt(groupId, btn) { let group = document.getElementById(groupId); let btns = group.getElementsByClassName("option-btn"); for(let b of btns) b.classList.remove("selected"); btn.classList.add("selected"); if(groupId === 'qGender') userData.gender = btn.innerText; if(groupId === 'qGoal') userData.goal = btn.innerText; if(groupId === 'qPhase') userData.phase = btn.innerText; }
        function startScan() {
            let h = document.querySelector('input[placeholder="HEIGHT (CM)"]').value; let w = document.querySelector('input[placeholder="WEIGHT (KG)"]').value; let age = document.getElementById('ageInput').value; let splitIndex = document.getElementById("scanSplitSelect").value;
            if(splitIndex === "") return alert("PLEASE SELECT A PROTOCOL.");
            if(h) userData.height = parseInt(h); if(w) userData.weight = parseInt(w); if(age) userData.age = parseInt(age);
            if(splitIndex == 0) userData.freq = 3; else if(splitIndex == 1) userData.freq = 4; else if(splitIndex == 2) userData.freq = 5; else userData.freq = 6;
            userData.proteinStrategy = "HIGH"; 
            
            // SAVE PERMANENTLY
            save('mfn_bio_data', JSON.stringify(userData)); 
            
            let selectedSplit = allSplits[splitIndex];
            let protocolData = { name: selectedSplit.name, cycle: selectedSplit.days, startDate: new Date().toISOString() };
            save('mfn_active_protocol', JSON.stringify(protocolData)); 
            document.getElementById('bioScanBtn').style.display = 'none';
            document.getElementById("questionsUI").style.display = "none"; document.getElementById("scanningUI").style.display = "block";
            setTimeout(() => { document.getElementById("scanLoaderFill").style.width = "100%"; }, 100); setTimeout(() => { document.getElementById("scanText").innerText = "MEASURING CNS RECOVERY..."; }, 800); setTimeout(() => { document.getElementById("scanText").innerText = "OPTIMIZING TRAJECTORY..."; }, 1600); setTimeout(() => { calculateDiet(userData); toggleModal(); location.reload(); }, 2500);
        }
        function calculateDiet(data) { 
            let bmr = data.gender === "MALE" ? (10 * data.weight) + (6.25 * data.height) - (5 * data.age) + 5 : (10 * data.weight) + (6.25 * data.height) - (5 * data.age) - 161; 
            let activity = 1.2; if (data.freq >= 3) activity = 1.375; if (data.freq >= 5) activity = 1.55; if (data.freq >= 6) activity = 1.725; 
            let tdee = Math.round(bmr * activity); let finalCal = tdee; if (data.phase === "BULK") finalCal += 400; if (data.phase === "CUT") finalCal -= 400; 
            let p_ratio = data.proteinStrategy === "LOW" ? 1.6 : 2.2; let targetP = Math.round(data.weight * p_ratio); let targetF = Math.round(data.weight * 0.9); let calsUsed = (targetP * 4) + (targetF * 9); let remaining = finalCal - calsUsed; let targetC = Math.round(remaining / 4);
            document.getElementById("calsTarget").innerText = finalCal; document.getElementById("protTarget").innerText = targetP; document.getElementById("carbTarget").innerText = targetC; document.getElementById("fatTarget").innerText = targetF; updateDietUI(); 
        }
        function changeStrategy() { let strat = document.getElementById("protStrategy").value; userData.proteinStrategy = strat; save('mfn_bio_data', JSON.stringify(userData)); calculateDiet(userData); }
        function getScheme(type) { if(type==="mobility")return{s:"2 Sets",r:"30 Sec",rest:"None"}; if(userData.goal==="POWER"){if(type==="compound")return{s:"5 Sets",r:"5 Reps",rest:"3-5 Min"};return{s:"3 Sets",r:"8-10 Reps",rest:"2 Min"};} return{s:"3 Sets",r:"10-12 Reps",rest:"90 Sec"}; }
        
        async function fetchFoodData() { 
            let query = document.getElementById("foodSearch").value.toLowerCase().trim(); let qty = parseFloat(document.getElementById("foodQty").value); let unit = document.getElementById("foodUnit").value; if(!query || !qty) return alert("INVALID INPUT"); let btn = document.getElementById("addFoodBtn"); btn.innerText = "CALCULATING..."; btn.disabled = true; let mult = unit === 'g' ? qty/100 : (unit === 'tbsp' ? qty*0.15 : qty); 
            if (customOverrides[query]) { addFoodToLog(query, customOverrides[query], mult, qty, unit); btn.innerText = "INJECT"; btn.disabled = false; return; } 
            try { let res = await fetch(`https://api.edamam.com/api/food-database/v2/parser?app_id=${APP_ID}&app_key=${APP_KEY}&ingr=${encodeURIComponent(query)}`); let data = await res.json(); 
            if(data.parsed.length > 0 || data.hints.length > 0) { let food = data.parsed.length > 0 ? data.parsed[0].food : data.hints[0].food; let base = { k: food.nutrients.ENERC_KCAL||0, p: food.nutrients.PROCNT||0, c: food.nutrients.CHOCDF||0, f: food.nutrients.FAT||0 }; addFoodToLog(data.text || query, base, mult, qty, unit); } else alert("UNKNOWN SUBSTANCE"); } catch(e) { alert("DB ERROR"); } btn.innerText = "INJECT"; btn.disabled = false; 
        }
        const customOverrides = { "chicken breast": {k:165,p:31,c:0,f:3.6}, "rice": {k:130,p:2.7,c:28,f:0.3}, "egg": {k:72,p:6,c:0.4,f:5}, "oats": {k:389,p:16,c:66,f:7} };
        let dailyLog = { p: 0, c: 0, f: 0, k: 0, list: [] };
        const workoutLibrary = { "REST": [{name:"Cat-Cow",type:"mobility"},{name:"Child's Pose",type:"mobility"},{name:"90/90 Hip",type:"mobility"}], "PUSH": [{name:"Bench Press",type:"compound"},{name:"Incline DB Press",type:"accessory"},{name:"Overhead Press",type:"compound"},{name:"Lat Raise",type:"isolation"},{name:"Tricep Pushdown",type:"isolation"}], "PULL": [{name:"Pull-Ups",type:"compound"},{name:"Rows",type:"accessory"},{name:"Face Pulls",type:"isolation"},{name:"Curls",type:"isolation"},{name:"Hammer Curls",type:"isolation"}], "LEGS": [{name:"Squat",type:"compound"},{name:"RDL",type:"compound"},{name:"Leg Ext",type:"isolation"},{name:"Calf Raise",type:"isolation"},{name:"Abs",type:"isolation"}], "UPPER_POWER": [{name:"Bench Press",type:"compound"},{name:"Pull-Up",type:"compound"},{name:"OHP",type:"compound"},{name:"Row",type:"compound"},{name:"Skullcrushers",type:"isolation"}], "LOWER_POWER": [{name:"Squat",type:"compound"},{name:"Deadlift",type:"compound"},{name:"Leg Press",type:"accessory"},{name:"Calf Raise",type:"isolation"}], "UPPER_HYPERTROPHY": [{name:"Incline Press",type:"accessory"},{name:"Cable Row",type:"accessory"},{name:"Lat Raise",type:"isolation"},{name:"Face Pull",type:"isolation"},{name:"Curls",type:"isolation"}], "LOWER_HYPERTROPHY": [{name:"Split Squat",type:"accessory"},{name:"Leg Ext",type:"isolation"},{name:"Leg Curl",type:"isolation"},{name:"Calf Raise",type:"isolation"}], "FB_A": [{name:"Hack Squat",type:"compound"},{name:"Incline Press",type:"accessory"},{name:"Lat Pulldown",type:"accessory"},{name:"Lat Raise",type:"isolation"},{name:"Curls",type:"isolation"}], "FB_B": [{name:"RDL",type:"compound"},{name:"OHP",type:"compound"},{name:"Row",type:"accessory"},{name:"Tricep Pushdown",type:"isolation"}] };

        function addFoodToLog(name, base, mult, qty, unit) { let k = Math.round(base.k * mult); let p = Math.round(base.p * mult); let c = Math.round(base.c * mult); let f = Math.round(base.f * mult); dailyLog.p += p; dailyLog.c += c; dailyLog.f += f; dailyLog.k += k; dailyLog.list.push({name:`${qty}${unit} ${name}`,k,p,c,f}); saveAndRender(); document.getElementById("foodSearch").value = ""; }
        function saveAndRender() { save('mfn_food_log', JSON.stringify(dailyLog)); updateDietUI(); renderFoodList(); }
        function updateDietUI() { 
            document.getElementById("calsConsumed").innerText = dailyLog.k; 
            document.getElementById("protCurrent").innerText = dailyLog.p;
            document.getElementById("carbCurrent").innerText = dailyLog.c;
            document.getElementById("fatCurrent").innerText = dailyLog.f;
            let target = parseInt(document.getElementById("calsTarget").innerText); let pct = (dailyLog.k / target) * 100; if(pct>100) pct=100; document.getElementById("calBar").style.width = pct+"%"; if(dailyLog.k >= (target * 0.9)) setTaskComplete('diet'); 
        }
        function renderFoodList() { let list = document.getElementById("foodLog"); list.innerHTML = ""; dailyLog.list.forEach((item, i) => { let div = document.createElement("div"); div.className="log-item"; div.innerHTML=`<div class="log-info"><span class="log-name">${item.name}</span><span class="log-macros">${item.k}kc | ${item.p}p ${item.c}c ${item.f}f</span></div>`; list.prepend(div); }); }
        
        function updateWater(amount) { 
            if(isTimerActive('water')) return; // Physically stop function if locked
            waterIntake += amount; if(waterIntake < 0) waterIntake = 0; save('mfn_water_today', waterIntake.toFixed(2)); updateWaterUI(); if(waterIntake >= 3.7) setTaskComplete('water'); 
        }
        function updateWaterUI() { document.getElementById("waterCurrent").innerText = waterIntake.toFixed(1); let pct = (waterIntake/waterGoal)*100; if(pct>100) pct=100; let fill = document.getElementById("waterFill"); fill.style.height = pct+"%"; if(waterIntake >= 3.7) fill.classList.add("success"); else fill.classList.remove("success"); }
        
        function quickLogSleep() { 
            if(isTimerActive('sleep')) return; // Physically stop function if locked
            let val = parseFloat(document.getElementById("quickSleepInput").value); if(!val || val<=0) return alert("ENTER VALID HOURS."); let h = Math.floor(val); let logText = h+"h "; document.getElementById("lastSleepLog").innerText = "LAST RECORD: " + logText; save('mfn_last_sleep', logText); if(val >= 8) setTaskComplete('sleep'); else alert("SLEEP LOGGED (NO XP: < 8 HOURS)"); document.getElementById("quickSleepInput").value = ""; 
        }
        function resetProtocol() { localStorage.removeItem(getUserPrefix() + 'mfn_active_protocol'); localStorage.removeItem(getUserPrefix() + 'mfn_workout_progress'); localStorage.removeItem(getUserPrefix() + 'mfn_task_timers'); location.reload(); }
    </script>
</body>
</html>